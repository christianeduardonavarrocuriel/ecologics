<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Recolector - EcoRecolecci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #mapaSolicitud, #mapaSeguimiento, #mapaRutas, #mapaSugerir, #mapaDetallesSolicitud {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        #mapaSeguimiento, #mapaRutas {
            height: 500px;
        }
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .map-header {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }
        .map-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .map-header p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: #6b7280;
        }
        .sidebar-menu-item {
            transition: all 0.3s ease;
        }
        .sidebar-menu-item:hover {
            transform: translateX(4px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-green-600 to-green-700 text-white flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6">
                <h1 class="text-2xl font-bold">EcoRecolecci√≥n</h1>
                <p class="text-green-100 text-sm mt-1">Panel de Recolector</p>
            </div>
            <nav class="flex-1 px-3 space-y-2">
                <button onclick="changeView('inicio')" data-view="inicio" class="sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg bg-white text-black shadow-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span>Inicio</span>
                </button>
                <button onclick="changeView('solicitudes')" data-view="solicitudes" class="sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-white hover:bg-green-500/30">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 012-2h6a2 2 0 012 2v2h2a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V7a2 2 0 012-2h2V3z"></path></svg>
                    <span>Solicitudes Disponibles</span>
                </button>
                <button onclick="changeView('mis-recolecciones')" data-view="mis-recolecciones" class="sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-white hover:bg-green-500/30">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2h10a1 1 0 000-2 2 2 0 00-2 2v10a2 2 0 002 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 000-2H7z"></path></svg>
                    <span>Mis Recolecciones</span>
                </button>
                <button onclick="changeView('rutas')" data-view="rutas" class="sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-white hover:bg-green-500/30">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9 3a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm7 4a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                    <span>Rutas</span>
                </button>
                <button onclick="changeView('perfil')" data-view="perfil" class="sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-white hover:bg-green-500/30">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path></svg>
                    <span>Mi Perfil</span>
                </button>
            </nav>
            <div class="p-4 border-t border-green-500">
                <button onclick="logout()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-sm font-medium transition">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between">
                <div>
                    <h2 id="headerTitle" class="text-2xl font-bold text-gray-800">Panel de Inicio</h2>
                    <p id="headerSubtitle" class="text-sm text-gray-500">Bienvenido de vuelta</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3 px-4 py-2 bg-gradient-to-r from-green-50 to-blue-50 rounded-full">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">CM</div>
                        <div>
                            <p id="headerUserName" class="text-sm font-medium text-gray-800">Cargando...</p>
                            <p class="text-xs text-gray-500">Recolector</p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto p-8">
                <div class="text-center py-12">
                    <div class="inline-block loader"></div>
                    <p class="mt-4 text-gray-600">Cargando panel...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Detalles de Solicitud -->
    <div id="modalDetalles" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-green-600 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">Detalles de la Solicitud</h2>
                    <button onclick="cerrarModalDetalles()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="modalContenido" class="p-6">
                <div class="text-center py-8">
                    <p class="text-gray-500">Cargando detalles...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Finalizar Recolecci√≥n -->
    <div id="modalFinalizarRecoleccion" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-green-600 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">Finalizar Recolecci√≥n</h2>
                    <button onclick="cerrarModalFinalizarRecoleccion()" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="formFinalizarRecoleccion" class="space-y-6">
                    <input type="hidden" id="idSolicitudFinalizar" value="">
                    
                    <!-- Fecha de Finalizaci√≥n -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Finalizaci√≥n</label>
                        <input type="datetime-local" id="fechaFinalizacion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" required>
                    </div>
                    
                    <!-- Tipo de Evidencia -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Finalizaci√≥n</label>
                        <select id="tipoEvidencia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" required>
                            <option value="">-- Selecciona el tipo --</option>
                            <option value="completada">‚úÖ Completada (F√≠sica)</option>
                            <option value="completada-usuario">‚úÖ Completada (Con Usuario)</option>
                            <option value="no-completada">‚ùå No Completada</option>
                            <option value="no-encontrada">üîç Direcci√≥n No Encontrada</option>
                            <option value="usuario-ausente">üë§ Usuario Ausente</option>
                            <option value="fallo-vehiculo">üöó Fallo en Veh√≠culo</option>
                            <option value="acceso-denegado">üö´ Acceso Denegado</option>
                            <option value="otro">‚ùì Otro</option>
                        </select>
                    </div>
                    
                    <!-- Notas -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Notas (Opcional)</label>
                        <textarea id="notasFinalizacion" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Detalles adicionales de la recolecci√≥n..."></textarea>
                    </div>
                    
                    <!-- Ubicaci√≥n Actual -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-semibold text-gray-700">Ubicaci√≥n Actual</label>
                            <button type="button" onclick="obtenerUbicacionActual()" class="px-3 py-1 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                üìç Obtener GPS
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-600">Latitud</label>
                                <input type="number" id="latFinalizacion" step="0.000001" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Longitud</label>
                                <input type="number" id="lngFinalizacion" step="0.000001" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Foto de Evidencia -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Foto de Evidencia (Opcional)</label>
                        <input type="file" id="fotoEvidencia" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    
                    <!-- Botones -->
                    <div class="flex gap-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="cerrarModalFinalizarRecoleccion()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Finalizar Recolecci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/assets/js/mapas.js"></script>
    <script>
        const API_BASE = '/api';
        let currentView = 'inicio';

        // Cargar datos del usuario
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/usuario/perfil`);
                const data = await response.json();
                document.getElementById('headerUserName').textContent = data.nombre;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Actualizar estado visual del sidebar
        function updateSidebar() {
            const buttons = document.querySelectorAll('.sidebar-menu-item');
            buttons.forEach(button => {
                const viewName = button.getAttribute('data-view');
                if (viewName === currentView) {
                    button.className = 'sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg bg-white text-black shadow-lg';
                } else {
                    button.className = 'sidebar-menu-item w-full flex items-center gap-3 px-3 py-3 rounded-lg text-white hover:bg-green-500/30';
                }
            });
        }

        // Cambiar vista
        function changeView(view) {
            currentView = view;
            updateSidebar();
            const mainContent = document.getElementById('mainContent');
            
            const titles = {
                'inicio': { title: 'Panel de Inicio', subtitle: 'Resumen de tu actividad' },
                'solicitudes': { title: 'Solicitudes Disponibles', subtitle: 'Nuevas recolecciones para ti' },
                'mis-recolecciones': { title: 'Mis Recolecciones', subtitle: 'Historial de tus recolecciones' },
                'rutas': { title: 'Mapa de Recolectores', subtitle: 'Ubicaci√≥n de todos los recolectores' },
                'perfil': { title: 'Mi Perfil', subtitle: 'Informaci√≥n personal' }
            };
            
            document.getElementById('headerTitle').textContent = titles[view]?.title || 'Panel';
            document.getElementById('headerSubtitle').textContent = titles[view]?.subtitle || '';
            
            mainContent.innerHTML = '<div class="text-center py-12"><div class="inline-block loader"></div></div>';
            
            switch(view) {
                case 'inicio':
                    loadInicio();
                    break;
                case 'solicitudes':
                    loadSolicitudes();
                    break;
                case 'mis-recolecciones':
                    loadMisRecolecciones();
                    break;
                case 'rutas':
                    loadRutas();
                    break;
                case 'perfil':
                    loadPerfil();
                    break;
                default:
                    mainContent.innerHTML = '<p class="text-gray-500">Secci√≥n en desarrollo</p>';
            }
        }

        // Vista Inicio
        async function loadInicio() {
            try {
                const response = await fetch(`${API_BASE}/recolector/estadisticas`);
                const stats = await response.json();
                
                const html = `
                    <div class="space-y-6">
                        <!-- Widget de Ubicaci√≥n en Tiempo Real -->
                        <div class="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L9.9 4.05a7 7 0 00-9.9 0zM9 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                    <h2 class="text-2xl font-bold">Mi Ubicaci√≥n en Tiempo Real</h2>
                                </div>
                                <div id="ubicacionBadge" class="text-sm font-medium px-3 py-1 bg-green-500 rounded-full">Esperando ubicaci√≥n...</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-green-100 text-sm mb-1">üìç Latitud</p>
                                    <p id="ubicacionLat" class="text-3xl font-bold">--</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-green-100 text-sm mb-1">üìç Longitud</p>
                                    <p id="ubicacionLng" class="text-3xl font-bold">--</p>
                                </div>
                            </div>
                            
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 mb-4">
                                <p class="text-green-100 text-sm mb-2">‚è∞ √öltima actualizaci√≥n</p>
                                <p id="ubicacionTime" class="text-lg font-medium">No enviada a√∫n</p>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="enviarUbicacion()" class="flex-1 bg-white hover:bg-gray-100 text-green-700 font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2 shadow-lg">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                    Enviar Mi Ubicaci√≥n Ahora
                                </button>
                            </div>
                            <p id="ubicacionMsg" class="text-green-100 text-sm mt-3 text-center"></p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">Solicitudes Pendientes</span>
                                    <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"></path></svg>
                                </div>
                                <p class="text-3xl font-bold text-gray-800">${stats.pendientes}</p>
                            </div>
                            
                            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">En Proceso</span>
                                    <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z"></path></svg>
                                </div>
                                <p class="text-3xl font-bold text-gray-800">${stats.en_proceso}</p>
                            </div>
                            
                            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">Completadas</span>
                                    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"></path></svg>
                                </div>
                                <p class="text-3xl font-bold text-gray-800">${stats.completadas}</p>
                            </div>
                            
                            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-600">Kilos Recolectados</span>
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.4 14.4a2 2 0 01-1.414-3.414L9 5.586l6.828 6.828a2 2 0 11-2.828 2.828L9 11.172l-4.6 4.6a2 2 0 01-2.828-2.828l4.6-4.6a1 1 0 00-1.414-1.414L4.4 14.4z"></path></svg>
                                </div>
                                <p class="text-3xl font-bold text-gray-800">${stats.total_kilos}</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Actividad Reciente</h3>
                            <div class="space-y-3">
                                ${stats.actividad && stats.actividad.length > 0 ? stats.actividad.map(a => `
                                    <div class="flex items-start gap-4 pb-3 border-b border-gray-100 last:border-0">
                                        <div class="text-xs text-gray-500 min-w-max">${new Date(a.fecha_finalizacion).toLocaleDateString()}</div>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-800">${a.tipo_residuo} ‚Ä¢ ${a.kilos_recolectados} kg</p>
                                            <p class="text-xs text-gray-500">Solicitud #${a.id_solicitud}</p>
                                        </div>
                                        <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">Completada</span>
                                    </div>
                                `).join('') : '<p class="text-sm text-gray-500">No hay recolecciones completadas</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mainContent').innerHTML = '<p class="text-red-500">Error cargando datos</p>';
            }
        }

        // Vista Solicitudes con Mapa
        async function loadSolicitudes() {
            try {
                const response = await fetch(`${API_BASE}/recolector/solicitudes-disponibles`);
                const solicitudes = await response.json();
                
                const html = `
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl"></div>
                                <div>
                                    <h3 class="font-semibold text-gray-800 text-lg">Solicitudes Disponibles</h3>
                                    <p class="text-sm text-gray-600">Total: ${solicitudes.length} recolecciones pendientes</p>
                                </div>
                            </div>
                        </div>
                        
                        ${solicitudes.length > 0 ? solicitudes.map(s => `
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg hover:border-green-300 transition">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h3 class="font-semibold text-gray-800 text-lg">${s.tipo_residuo}</h3>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">${s.kilos} kg</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-1">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                            ${s.calle || ''} ${s['numero exterior'] || ''}, ${s.colonia || ''}, ${s['codigo postal'] || ''}
                                        </p>
                                        <p class="text-xs text-gray-500">ID: #${s.id_solicitud}</p>
                                    </div>
                                </div>
                                
                                ${s.info_extra ? `<p class="text-sm text-gray-600 mb-3 italic">"${s.info_extra}"</p>` : ''}
                                
                                <div class="flex gap-2">
                                    <button onclick="verDetallesSolicitud(${s.id_solicitud})" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                        </svg>
                                        Ver Ubicaci√≥n
                                    </button>
                                    <button onclick="aceptarSolicitud(${s.id_solicitud})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Aceptar
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-center py-12"><p class="text-gray-500 text-lg">No hay solicitudes disponibles</p></div>'}
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mainContent').innerHTML = '<p class="text-red-500">Error cargando solicitudes</p>';
            }
        }

        // Vista Mis Recolecciones
        async function loadMisRecolecciones() {
            try {
                const response = await fetch(`${API_BASE}/recolector/mis-recolecciones`);
                const recolecciones = await response.json();
                
                const html = `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200 mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Mis Recolecciones en Proceso</h3>
                            <p class="text-sm text-gray-600">Total: ${recolecciones.length} recolecciones asignadas</p>
                        </div>
                        
                        ${recolecciones.length > 0 ? recolecciones.map(r => `
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg hover:border-green-300 transition">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h3 class="font-semibold text-gray-800 text-lg">#${r.id_solicitud} - ${r.tipo_residuo}</h3>
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">${r.kilos} kg</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-1">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            </svg>
                                            ${r.calle || ''} ${r.numero_exterior || ''}, ${r.colonia || ''}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            üìÖ ${new Date(r.fecha_solicitud).toLocaleDateString()}
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${
                                            r.estado === 'completada' ? 'bg-green-100 text-green-800' :
                                            r.estado === 'en-proceso' ? 'bg-blue-100 text-blue-800' :
                                            'bg-orange-100 text-orange-800'
                                        }">${r.estado}</span>
                                    </div>
                                </div>
                                
                                ${r.referencias ? `<p class="text-sm text-gray-600 mb-3"><strong>Referencias:</strong> ${r.referencias}</p>` : ''}
                                ${r.info_extra ? `<p class="text-sm text-gray-600 mb-3 italic text-blue-600">${r.info_extra}</p>` : ''}
                                
                                <div class="flex gap-2 pt-3 border-t border-gray-100">
                                    <button onclick="completarRecoleccion(${r.id_solicitud})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        Marcar como Completada
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-center py-12"><p class="text-gray-500 text-lg">No tienes recolecciones asignadas</p></div>'}
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mainContent').innerHTML = '<p class="text-red-500">Error cargando recolecciones</p>';
            }
        }

        // Vista Seguimiento con Mapa
        function loadSeguimiento() {
            const html = `
                <div class="map-container">
                    <div class="map-header bg-gradient-to-r from-blue-50 to-cyan-50">
                        <h3>Seguimiento en Tiempo Real</h3>
                        <p>Ubicaci√≥n actual del recolector (actualizaci√≥n cada 5s)</p>
                    </div>
                    <div id="mapaSeguimiento" class="rounded-lg overflow-hidden"></div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            setTimeout(async () => await initSeguimientoMap('mapaSeguimiento', 1), 100);
        }

        // Vista Rutas con Mapa
        async function loadRutas() {
            const html = `
                <div class="map-container">
                    <div class="map-header bg-gradient-to-r from-purple-50 to-blue-50">
                        <h3>üó∫Ô∏è Ubicaci√≥n de Recolectores en Tiempo Real</h3>
                        <p id="recolectoresCount">Cargando recolectores activos...</p>
                    </div>
                    <div id="mapaRutas" style="height: 600px;" class="rounded-lg overflow-hidden"></div>
                </div>
                
                <div class="mt-6 bg-white rounded-xl p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üìç Lista de Recolectores</h3>
                    <div id="listaRecolectores" class="space-y-3">
                        <p class="text-sm text-gray-500">Cargando...</p>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            
            // Cargar ubicaciones y renderizar mapa
            setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/recolectores/ubicaciones`);
                    const recolectores = await response.json();
                    
                    console.log('Recolectores cargados:', recolectores);
                    
                    document.getElementById('recolectoresCount').textContent = 
                        `${recolectores.length} recolectores activos en el mapa`;
                    
                    // Renderizar lista de recolectores
                    const listaDiv = document.getElementById('listaRecolectores');
                    if (recolectores.length > 0) {
                        listaDiv.innerHTML = recolectores.map((r, idx) => `
                            <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${r.nombre}</p>
                                    <p class="text-xs text-gray-500">${r.vehiculo || 'Veh√≠culo'} - ${r.placa || 'S/P'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">üìç ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</p>
                                    <p class="text-xs text-green-600">üü¢ Activo</p>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        listaDiv.innerHTML = '<p class="text-sm text-gray-500">No hay recolectores con ubicaci√≥n disponible</p>';
                    }
                    
                    // Inicializar mapa con Mapbox
                    await initRutasMapConRecolectores('mapaRutas', recolectores);
                } catch (error) {
                    console.error('Error cargando recolectores:', error);
                    document.getElementById('listaRecolectores').innerHTML = 
                        '<p class="text-sm text-red-500">Error al cargar recolectores</p>';
                }
            }, 100);
        }

        // Vista Perfil
        async function loadPerfil() {
            try {
                const response = await fetch(`${API_BASE}/usuario/perfil`);
                const perfil = await response.json();
                
                const html = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl p-8 border border-gray-200">
                                <div class="flex items-center gap-6 mb-8">
                                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                        ${perfil.nombre.charAt(0)}${perfil.apellidos.charAt(0)}
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800">${perfil.nombre} ${perfil.apellidos}</h2>
                                        <p class="text-gray-600">@${perfil.username}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2.94 6.412A2 2 0 002 8.25V16a2 2 0 002 2h12a2 2 0 002-2V8.25a2 2 0 00-.94-1.838l-8-4A2 2 0 008 0H8a2 2 0 00-1.06.374l-8 4z"></path></svg>
                                        <div>
                                            <p class="text-sm text-gray-600">Email</p>
                                            <p class="text-gray-800">${perfil.email}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773c.418 1.265 1.215 2.807 2.604 4.196 1.389 1.389 2.93 2.186 4.196 2.604l.773-1.548a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                                        <div>
                                            <p class="text-sm text-gray-600">Tel√©fono</p>
                                            <p class="text-gray-800">${perfil.telefono}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L9.9 4.05a7 7 0 00-9.9 0zM9 11a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                                        <div>
                                            <p class="text-sm text-gray-600">Direcci√≥n</p>
                                            <p class="text-gray-800">${perfil.direccion}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function logout() {
            window.location.href = '/logout';
        }

        // Aceptar solicitud
        async function aceptarSolicitud(idSolicitud) {
            if (!confirm('¬øDeseas aceptar esta solicitud de recolecci√≥n?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/recolector/aceptar-solicitud/${idSolicitud}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Solicitud aceptada correctamente');
                    // Recargar la lista de solicitudes
                    loadSolicitudesDisponibles();
                } else {
                    alert('‚ùå Error: ' + (result.error || 'No se pudo aceptar la solicitud'));
                }
            } catch (error) {
                console.error('Error al aceptar solicitud:', error);
                alert('‚ùå Error de conexi√≥n. Intenta de nuevo.');
            }
        }
        
        // Completar recolecci√≥n
        async function completarRecoleccion(idSolicitud) {
            document.getElementById('idSolicitudFinalizar').value = idSolicitud;
            document.getElementById('fechaFinalizacion').value = new Date().toISOString().slice(0, 16);
            document.getElementById('tipoEvidencia').value = '';
            document.getElementById('notasFinalizacion').value = '';
            document.getElementById('latFinalizacion').value = '';
            document.getElementById('lngFinalizacion').value = '';
            
            document.getElementById('modalFinalizarRecoleccion').classList.remove('hidden');
        }
        
        function cerrarModalFinalizarRecoleccion() {
            document.getElementById('modalFinalizarRecoleccion').classList.add('hidden');
        }
        
        // Obtener ubicaci√≥n actual
        function obtenerUbicacionActual() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta GPS');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById('latFinalizacion').value = position.coords.latitude.toFixed(6);
                    document.getElementById('lngFinalizacion').value = position.coords.longitude.toFixed(6);
                    alert('‚úÖ Ubicaci√≥n obtenida correctamente');
                },
                function(error) {
                    alert('‚ùå Error al obtener GPS: ' + error.message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        // Enviar formulario de finalizaci√≥n
        document.getElementById('formFinalizarRecoleccion').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const idSolicitud = document.getElementById('idSolicitudFinalizar').value;
            const tipo = document.getElementById('tipoEvidencia').value;
            
            if (!tipo) {
                alert('Selecciona el tipo de finalizaci√≥n');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('id_solicitud', idSolicitud);
                formData.append('fecha_finalizacion', document.getElementById('fechaFinalizacion').value);
                formData.append('tipo_evidencia', tipo);
                formData.append('notas', document.getElementById('notasFinalizacion').value);
                formData.append('lat_final', document.getElementById('latFinalizacion').value);
                formData.append('lng_final', document.getElementById('lngFinalizacion').value);
                
                const fotoInput = document.getElementById('fotoEvidencia');
                if (fotoInput.files.length > 0) {
                    formData.append('foto_evidencia', fotoInput.files[0]);
                }
                
                const response = await fetch(`${API_BASE}/recolector/finalizar-recoleccion`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Recolecci√≥n finalizada correctamente');
                    cerrarModalFinalizarRecoleccion();
                    loadMisRecolecciones();
                } else {
                    alert('‚ùå Error: ' + (result.error || 'No se pudo finalizar'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n.');
            }
        })

        // Ver detalles de solicitud con mapa
        let mapaDetalles = null;
        async function verDetallesSolicitud(idSolicitud) {
            try {
                const response = await fetch(`${API_BASE}/recolector/solicitudes-disponibles`);
                const solicitudes = await response.json();
                const solicitud = solicitudes.find(s => s.id_solicitud === idSolicitud);
                
                if (!solicitud) {
                    console.error('Solicitud no encontrada. ID buscado:', idSolicitud);
                    console.error('Solicitudes disponibles:', solicitudes);
                    alert('Solicitud no encontrada');
                    return;
                }
                
                const modal = document.getElementById('modalDetalles');
                const contenido = document.getElementById('modalContenido');
                
                contenido.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Informaci√≥n -->
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Informaci√≥n de la Recolecci√≥n</h3>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500">Tipo de Residuo</p>
                                            <p class="text-sm font-medium text-gray-800">${solicitud.tipo_residuo}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500">Cantidad</p>
                                            <p class="text-sm font-medium text-gray-800">${solicitud.kilos} kilogramos</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500">Direcci√≥n</p>
                                            <p class="text-sm font-medium text-gray-800">
                                                ${solicitud.calle || ''} ${solicitud['numero exterior'] || ''}<br>
                                                ${solicitud.colonia || ''}, CP ${solicitud['codigo postal'] || ''}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    ${solicitud.referencias ? `
                                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-gray-500">Referencias</p>
                                            <p class="text-sm font-medium text-gray-800">${solicitud.referencias}</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    ${solicitud.info_extra ? `
                                    <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                        </svg>
                                        <div>
                                            <p class="text-xs text-blue-600 font-medium">Informaci√≥n adicional</p>
                                            <p class="text-sm text-gray-700 italic">"${solicitud.info_extra}"</p>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="aceptarSolicitud(${solicitud.id_solicitud}); cerrarModalDetalles();" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-base font-semibold">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Aceptar esta Solicitud
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mapa -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Ubicaci√≥n en el Mapa</h3>
                            <div id="mapaDetallesSolicitud" class="w-full h-96 rounded-lg border border-gray-200"></div>
                            <p class="text-xs text-gray-500 mt-2 text-center">
                                üìç Coordenadas: ${solicitud.lat?.toFixed(6) || 'N/A'}, ${solicitud.lng?.toFixed(6) || 'N/A'}
                            </p>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                
                // Inicializar mapa despu√©s de que el modal sea visible
                setTimeout(() => {
                    if (solicitud.lat && solicitud.lng) {
                        if (mapaDetalles) {
                            mapaDetalles.remove();
                        }
                        
                        mapaDetalles = L.map('mapaDetallesSolicitud').setView([solicitud.lat, solicitud.lng], 15);
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(mapaDetalles);
                        
                        // Marcador personalizado
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #DC2626; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 3px solid white;">
                                    <svg style="width: 20px; height: 20px; color: white;" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                    </svg>
                                  </div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 40]
                        });
                        
                        L.marker([solicitud.lat, solicitud.lng], {icon: icon})
                            .addTo(mapaDetalles)
                            .bindPopup(`<b>${solicitud.tipo_residuo}</b><br>${solicitud.kilos} kg`)
                            .openPopup();
                    }
                }, 300);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar detalles de la solicitud');
            }
        }
        
        function cerrarModalDetalles() {
            document.getElementById('modalDetalles').classList.add('hidden');
            if (mapaDetalles) {
                mapaDetalles.remove();
                mapaDetalles = null;
            }
        }

        // Inicializar mapa de rutas con Mapbox mostrando todos los recolectores
        let mapaRutas = null;
        let markersRecolectores = [];
        
        async function initRutasMapConRecolectores(containerId, recolectores) {
            // Limpiar mapa anterior si existe
            if (mapaRutas) {
                mapaRutas.remove();
                mapaRutas = null;
            }
            
            markersRecolectores = [];
            
            if (!recolectores || recolectores.length === 0) {
                document.getElementById(containerId).innerHTML = 
                    '<div class="flex items-center justify-center h-full bg-gray-100"><p class="text-gray-500">No hay recolectores con ubicaci√≥n disponible</p></div>';
                return;
            }
            
            // Centro inicial: promedio de todas las ubicaciones
            const centerLat = recolectores.reduce((sum, r) => sum + r.lat, 0) / recolectores.length;
            const centerLng = recolectores.reduce((sum, r) => sum + r.lng, 0) / recolectores.length;
            
            // Obtener token de Mapbox
            let mapboxToken = null;
            try {
                const tokenRes = await fetch('/api/config/mapbox-token');
                if (tokenRes.ok) {
                    const data = await tokenRes.json();
                    mapboxToken = data.token;
                }
            } catch (e) {
                console.warn('No se pudo obtener token de Mapbox, usando OpenStreetMap');
            }
            
            // Inicializar mapa
            mapaRutas = L.map(containerId).setView([centerLat, centerLng], 13);
            
            // Agregar capa de mapa (Mapbox o fallback a OSM)
            if (mapboxToken) {
                L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`, {
                    tileSize: 512,
                    zoomOffset: -1,
                    attribution: '¬© Mapbox ¬© OpenStreetMap',
                    maxZoom: 18
                }).addTo(mapaRutas);
            } else {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(mapaRutas);
            }
            
            // Crear icono personalizado para recolectores
            const truckIcon = L.divIcon({
                html: `
                    <div style="position: relative;">
                        <div style="background: #22c55e; border: 3px solid white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                            <svg width="24" height="24" fill="white" viewBox="0 0 20 20">
                                <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                            </svg>
                        </div>
                        <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            üöõ
                        </div>
                    </div>
                `,
                className: 'custom-truck-marker',
                iconSize: [40, 50],
                iconAnchor: [20, 45]
            });
            
            // Agregar marcador para cada recolector
            recolectores.forEach((recolector, index) => {
                const marker = L.marker([recolector.lat, recolector.lng], { icon: truckIcon })
                    .addTo(mapaRutas)
                    .bindPopup(`
                        <div style="padding: 8px; min-width: 200px;">
                            <h3 style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #1f2937;">
                                üöõ ${recolector.nombre}
                            </h3>
                            <div style="font-size: 12px; color: #6b7280; line-height: 1.6;">
                                <p><strong>Veh√≠culo:</strong> ${recolector.vehiculo || 'No especificado'}</p>
                                <p><strong>Placa:</strong> ${recolector.placa || 'Sin placa'}</p>
                                <p><strong>Tel√©fono:</strong> ${recolector.telefono || 'N/A'}</p>
                                <p style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                    <strong>Ubicaci√≥n:</strong><br>
                                    üìç ${recolector.lat.toFixed(5)}, ${recolector.lng.toFixed(5)}
                                </p>
                            </div>
                        </div>
                    `);
                
                markersRecolectores.push(marker);
            });
            
            // Ajustar vista para mostrar todos los marcadores
            if (markersRecolectores.length > 0) {
                const group = L.featureGroup(markersRecolectores);
                mapaRutas.fitBounds(group.getBounds().pad(0.1));
            }
            
            console.log(`‚úÖ Mapa de rutas inicializado con ${recolectores.length} recolectores`);
        }

        // Enviar ubicaci√≥n del recolector
        function enviarUbicacion() {
            if (!navigator.geolocation) {
                alert('‚ùå Tu navegador no soporta geolocalizaci√≥n');
                document.getElementById('ubicacionMsg').textContent = '‚ùå Navegador no compatible';
                return;
            }
            
            document.getElementById('ubicacionBadge').textContent = 'üîÑ Obteniendo GPS...';
            document.getElementById('ubicacionBadge').className = 'text-sm font-medium px-3 py-1 bg-yellow-500 rounded-full';
            document.getElementById('ubicacionMsg').textContent = 'üì° Solicitando ubicaci√≥n GPS...';
            
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Actualizar interfaz
                    document.getElementById('ubicacionLat').textContent = lat.toFixed(6);
                    document.getElementById('ubicacionLng').textContent = lng.toFixed(6);
                    
                    const ahora = new Date();
                    const horaFormateada = ahora.toLocaleTimeString('es-MX', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    document.getElementById('ubicacionTime').textContent = `${horaFormateada} - ${ahora.toLocaleDateString('es-MX')}`;
                    
                    document.getElementById('ubicacionMsg').textContent = 'üì§ Enviando al servidor...';
                    
                    try {
                        // Enviar al servidor
                        const response = await fetch(`${API_BASE}/recolector/enviar-ubicacion`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ lat, lng })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            document.getElementById('ubicacionBadge').textContent = '‚úÖ Ubicaci√≥n Enviada';
                            document.getElementById('ubicacionBadge').className = 'text-sm font-medium px-3 py-1 bg-green-500 rounded-full animate-pulse';
                            document.getElementById('ubicacionMsg').textContent = `‚úÖ Ubicaci√≥n enviada correctamente a las ${horaFormateada}`;
                            
                            // Quitar animaci√≥n despu√©s de 2 segundos
                            setTimeout(() => {
                                document.getElementById('ubicacionBadge').className = 'text-sm font-medium px-3 py-1 bg-green-500 rounded-full';
                            }, 2000);
                        } else {
                            throw new Error(result.error || 'Error desconocido');
                        }
                    } catch (error) {
                        console.error('Error enviando ubicaci√≥n:', error);
                        document.getElementById('ubicacionBadge').textContent = '‚ùå Error al enviar';
                        document.getElementById('ubicacionBadge').className = 'text-sm font-medium px-3 py-1 bg-red-500 rounded-full';
                        document.getElementById('ubicacionMsg').textContent = '‚ùå Error al enviar al servidor';
                    }
                },
                function(error) {
                    console.error('Error GPS:', error);
                    document.getElementById('ubicacionBadge').textContent = '‚ùå Error GPS';
                    document.getElementById('ubicacionBadge').className = 'text-sm font-medium px-3 py-1 bg-red-500 rounded-full';
                    
                    let mensaje = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje = '‚ùå Permiso denegado. Activa la ubicaci√≥n en tu navegador.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje = '‚ùå Ubicaci√≥n no disponible.';
                            break;
                        case error.TIMEOUT:
                            mensaje = '‚ùå Tiempo de espera agotado.';
                            break;
                        default:
                            mensaje = '‚ùå Error desconocido al obtener GPS.';
                    }
                    document.getElementById('ubicacionMsg').textContent = mensaje;
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000, 
                    maximumAge: 0 
                }
            );
        }

        // Cargar datos iniciales
        loadUserProfile();
        loadInicio();
    </script>
</body>
</html>
